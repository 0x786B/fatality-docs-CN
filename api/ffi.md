> *需要启用“允许不安全操作”选项才能使用。* 

## FFI

用法：`ffi.{function}`

此表提供了 LuaJIT FFI（外部函数接口）相关的函数和属性。

## os

当前操作系统的名称。

**示例**

```lua
print(ffi.os) -- "Windows"
```

## arch

当前 CPU 架构的名称。

**示例**

```lua
print(ffi.arch) -- "x64"
```

## metatype

[![函数][这是一个必须使用点(.)调用的函数]rw]

为 C 类型关联元表。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ct` | `ctype` | C 类型对象。 |
| `metatable` | `table` | 要关联的元表。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `ctype` | 输入的 C 类型对象。 |

**示例**

```lua
local mt = {
  __add = function(a, b) return a.x + b.x end
}
local point_t = ffi.metatype("struct { int x; }", mt)
```

## sizeof

[![函数][这是一个必须使用点(.)调用的函数]rw]

获取 C 类型或对象的大小。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ct` | `ctype/cdata` | C 类型对象或 C 数据对象。 |
| `nelem` | `number` | （可选）数组元素数量。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `number` | 类型或对象的字节大小。 |

**示例**

```lua
local size = ffi.sizeof("int") -- 通常为 4
local arr_size = ffi.sizeof("int[10]") -- 40
```

## string

[![函数][这是一个必须使用点(.)调用的函数]rw]

从指针创建 Lua 字符串。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ptr` | `cdata` | 指向数据的指针。 |
| `len` | `number` | （可选）字符串长度。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `string` | 创建的 Lua 字符串。 |

**示例**

```lua
local str = ffi.string(ptr)
local str_len = ffi.string(ptr, 10)
```

## cdef

[![函数][这是一个必须使用点(.)调用的函数]rw]

声明 C 类型和外部函数。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `def` | `string` | C 声明字符串。 |

**示例**

```lua
ffi.cdef[[
typedef struct { int x, y; } point_t;
int printf(const char *fmt, ...);
]]
```

## new

[![函数][这是一个必须使用点(.)调用的函数]rw]

创建 C 数据对象。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ct` | `ctype/string` | C 类型对象或类型名称。 |
| `init` | `any` | （可选）初始值。 |
| `...` | `any` | （可选）更多初始值。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `cdata` | 新创建的 C 数据对象。 |

**示例**

```lua
local p = ffi.new("point_t")
local arr = ffi.new("int[10]")
```

## cast

[![函数][这是一个必须使用点(.)调用的函数]rw]

将 C 数据对象转换为不同的 C 类型。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ct` | `ctype/string` | 目标 C 类型。 |
| `init` | `cdata/number` | 要转换的值。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `cdata` | 转换后的 C 数据对象。 |

**示例**

```lua
local p = ffi.cast("int *", ptr)
```

## typeof

[![函数][这是一个必须使用点(.)调用的函数]rw]

创建 C 类型对象。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ct` | `string/ctype` | C 类型名称或对象。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `ctype` | C 类型对象。 |

**示例**

```lua
local t = ffi.typeof("int[?]")
local a = t(20) -- 创建大小为 20 的 int 数组
```

## typeinfo

[![函数][这是一个必须使用点(.)调用的函数]rw]

获取 C 类型的信息。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ct` | `string/ctype` | C 类型名称或对象。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `table` | 包含类型信息的表。 |

**示例**

```lua
local info = ffi.typeinfo("int[10]")
```

## istype

[![函数][这是一个必须使用点(.)调用的函数]rw]

检查 C 数据对象是否为指定类型。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ct` | `ctype/string` | C 类型对象或名称。 |
| `obj` | `cdata` | 要检查的对象。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `boolean` | 如果对象为指定类型则返回 true。 |

**示例**

```lua
local is_int = ffi.istype("int", obj)
```

## alignof

[![函数][这是一个必须使用点(.)调用的函数]rw]

获取 C 类型的对齐要求。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ct` | `ctype/string` | C 类型对象或名称。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `number` | 类型的对齐字节数。 |

**示例**

```lua
local align = ffi.alignof("int")
```

## offsetof

[![函数][这是一个必须使用点(.)调用的函数]rw]

获取结构体字段的偏移量。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `ct` | `ctype/string` | 结构体类型。 |
| `field` | `string` | 字段名称。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `number` | 字段的字节偏移量。 |

**示例**

```lua
local offset = ffi.offsetof("struct { int x, y; }", "y")
```

## errno

[![函数][这是一个必须使用点(.)调用的函数]rw]

获取或设置最后的系统错误代码。

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `number` | 错误代码。 |

**示例**

```lua
local err = ffi.errno()
```

## copy

[![函数][这是一个必须使用点(.)调用的函数]rw]

复制内存数据。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `dst` | `cdata` | 目标内存地址。 |
| `src` | `cdata` | 源内存地址。 |
| `len` | `number` | 要复制的字节数。 |

**示例**

```lua
ffi.copy(dst, src, 10)
```

## abi

[![函数][这是一个必须使用点(.)调用的函数]rw]

检查 C ABI 参数。

**参数**

| 名称 | 类型 | 描述 |
| ---- | ---- | ----------- |
| `param` | `string` | ABI 参数名称。 |

**返回值**

| 类型 | 描述 |
| ---- | ----------- |
| `boolean` | 如果支持该 ABI 参数则返回 true。 |

**示例**

```lua
local is_32bit = ffi.abi("32bit")
``` 